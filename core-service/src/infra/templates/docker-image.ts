// ═══════════════════════════════════════════════════════════════════
// Docker Image (Dockerfile) Template
// ═══════════════════════════════════════════════════════════════════

import type { DockerConfig } from '../types.js';

export function generateDockerfile(config: DockerConfig): string {
  const {
    name,
    port = 3000,
    healthPath = '/health',
    nodeVersion = '20',
    entryPoint = 'dist/index.js',
    serviceCorePackageName = 'service-core',
  } = config;
  
  // Convert service name to folder name (e.g., 'retail-api' stays 'retail-api')
  const appFolder = name;

  return `# ═══════════════════════════════════════════════════════════════════
# Multi-stage build for minimal image size
# Generated by service-core infra generator
# 
# BUILD FROM PARENT DIRECTORY:
#   docker build -f ${appFolder}/Dockerfile -t ${name} .
# ═══════════════════════════════════════════════════════════════════

# Stage 1: Build service-core
FROM node:${nodeVersion}-alpine AS service-core-builder
WORKDIR /build/service-core
COPY service-core/package*.json ./
RUN npm ci
COPY service-core/src ./src
COPY service-core/tsconfig.json ./
RUN npm run build

# Stage 2: Build app
FROM node:${nodeVersion}-alpine AS app-builder
WORKDIR /app

# Copy service-core built files
COPY --from=service-core-builder /build/service-core /service-core

# Copy app package files and install
COPY ${appFolder}/package*.json ./
RUN npm ci

# Install TypeScript for build
RUN npm install -D typescript

# Copy source and build
COPY ${appFolder}/src ./src
COPY ${appFolder}/tsconfig.json ./
RUN npx tsc

# Stage 3: Production
FROM node:${nodeVersion}-alpine AS production
WORKDIR /app

# Security: non-root user
RUN addgroup -g 1001 -S nodejs && adduser -S nodejs -u 1001
USER nodejs

# Copy built files
COPY --from=app-builder --chown=nodejs:nodejs /app/node_modules ./node_modules
COPY --from=app-builder --chown=nodejs:nodejs /app/dist ./dist
COPY --from=app-builder --chown=nodejs:nodejs /app/package.json ./
COPY --from=service-core-builder --chown=nodejs:nodejs /build/service-core /app/node_modules/${serviceCorePackageName}

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \\
  CMD wget --no-verbose --tries=1 --spider http://localhost:${port}${healthPath} || exit 1

# Environment
ENV NODE_ENV=production
ENV PORT=${port}

EXPOSE ${port}

CMD ["node", "${entryPoint}"]
`;
}

